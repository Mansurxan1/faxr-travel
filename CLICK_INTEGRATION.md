# Интеграция с платежной системой Click

В этом документе описаны шаги по настройке и использованию интеграции с платежной системой Click в проекте FAXR TRAVEL.

## Настройка переменных окружения

1. Откройте файл `.env.local` в корне проекта и убедитесь, что в нем присутствуют следующие переменные:

```
# Click Payment Integration
CLICK_SECRET_KEY=neLytpXHtYZ
CLICK_SERVICE_ID=68027
CLICK_MERCHANT_ID=36344
CLICK_MERCHANT_USER_ID=52608
CLICK_SPIC_CODE=12345678901234567
CLICK_PACKAGE_CODE=PC001

# Telegram Bot
TELEGRAM_BOT_TOKEN=7553458611:AAFeqiYxdyzvD_lJy4adf8W-dK5lCRnIG9s
TELEGRAM_CHAT_ID=5283151626
```

2. Замените значения переменных на актуальные данные вашего аккаунта Click.

## Настройка Telegram-бота

1. Для получения ID чата, в который будут приходить уведомления о платежах, запустите сервер разработки:

```bash
npm run dev
```

2. Откройте в браузере URL: `http://localhost:5174/api/telegram/setup`

3. Следуйте инструкциям на странице:
   - Добавьте бота в нужный чат или группу
   - Отправьте сообщение в чат с ботом
   - Обновите страницу, чтобы увидеть ID чата
   - Добавьте ID чата в переменную окружения `TELEGRAM_CHAT_ID` в файле `.env.local`

## Процесс оплаты

1. Пользователь нажимает кнопку "Купить" на странице тура
2. Система отображает форму для ввода имени и телефона пользователя
3. После заполнения формы система создает заказ и перенаправляет пользователя на страницу оплаты Click
4. После успешной оплаты пользователь перенаправляется на страницу успешной оплаты
5. Уведомления о платежах с данными пользователя отправляются в настроенный Telegram-чат
6. Система автоматически фискализирует чек через API Click с использованием реальных данных пользователя

## Хранение данных заказа

Для обеспечения корректной работы фискализации и отслеживания заказов, система сохраняет информацию о каждом заказе в файловой системе. Это позволяет:

1. **Использовать реальные данные пользователя** при фискализации чека
2. **Отслеживать статус заказа** на всех этапах обработки
3. **Обеспечивать целостность данных** между созданием заказа и его оплатой

### Структура данных заказа

```javascript
{
  "orderId": "1740757107845",
  "tourId": "123",
  "tourName": "Тур в Самарканд",
  "price": "1000000",
  "userId": "user123",
  "userName": "Иван Иванов",
  "userPhone": "+998 90 123 45 67",
  "status": "Создан",
  "createdAt": "2023-06-28T12:34:56.789Z"
}
```

При подтверждении платежа, статус заказа обновляется на "Оплачен" и добавляется информация о платеже:

```javascript
{
  "status": "Оплачен",
  "paidAt": "2023-06-28T13:00:00.000Z",
  "clickTransId": "12345678"
}
```

### Расположение файлов заказов

Файлы с данными заказов хранятся в директории `data/orders/` в корне проекта. Каждый заказ сохраняется в отдельном файле с именем `{orderId}.json`.

## API-маршруты

- `/api/click` - Инициализация платежа и сохранение данных заказа
- `/api/click/notify` - Обработка уведомлений от Click и фискализация чеков с использованием сохраненных данных заказа
- `/api/telegram/notify` - Отправка уведомлений в Telegram
- `/api/click/status` - Проверка статуса подключения к Click

## Фискализация чеков

В соответствии с требованиями законодательства Узбекистана, система автоматически отправляет фискальные данные в ОФД через API Click. Для этого используются следующие параметры:

- `CLICK_SPIC_CODE` - Код ИКПУ (Идентификационный код предприятия учёта)
- `CLICK_PACKAGE_CODE` - Код упаковки

### Процесс фискализации

1. После успешной оплаты система получает уведомление от Click через API-маршрут `/api/click/notify`
2. Система проверяет подпись запроса и тип действия (action=1 - подтверждение платежа)
3. Система получает сохраненные данные заказа (имя тура, имя и телефон клиента)
4. Если платеж подтвержден, система вызывает функцию `fiscalizeReceipt` для фискализации чека с использованием реальных данных пользователя
5. Функция формирует данные для фискализации и отправляет запрос на API Click
6. Результат фискализации отправляется в Telegram-бот

### Полный процесс фискализации

Фискализация в системе реализована в соответствии с требованиями Click и включает следующие шаги:

1. **Создание фискального чека** - отправка запроса на `https://api.click.uz/v2/merchant/receipt/fiscal` с данными о товаре/услуге, клиенте и платеже.

2. **Отправка данных о товарах и услугах** - после успешного создания чека система отправляет детальные данные о товарах и услугах на `https://api.click.uz/v2/merchant/payment/ofd_data/submit_items`. Данные включают:
   - Название товара/услуги
   - Код ИКПУ
   - Код упаковки
   - Цену в тийинах (1 сум = 100 тийин)
   - Количество
   - Сумму и процент НДС
   - Способ оплаты (наличные, безналичные, электронные)

3. **Получение ссылки на фискальный чек** - система запрашивает ссылку на фискальный чек через `https://api.click.uz/v2/merchant/payment/ofd_data/{service_id}/{payment_id}`.

4. **Отправка QR-кода чека** - полученная ссылка на чек отправляется обратно в Click через `https://api.click.uz/v2/merchant/payment/ofd_data/submit_qrcode`.

### Проверка работы фискализации

Для проверки корректности работы фискализации можно использовать следующие методы:

1. **Проверка логов сервера** - в консоли сервера выводятся подробные логи о запросах к API фискализации и ответах от него. Ищите сообщения, начинающиеся с:
   - "Отправка запроса на фискализацию чека"
   - "Ответ от API фискализации"
   - "Отправка данных о товарах и услугах"
   - "Получение фискальных данных для платежа"
   - "Отправка фискализированного чека"

2. **Проверка уведомлений в Telegram** - после успешной фискализации в Telegram-бот отправляется уведомление с информацией о фискальном чеке, включая его ID.

3. **Проверка через личный кабинет Click** - в личном кабинете Click можно проверить статус фискализации платежей в разделе "Фискальные чеки".

4. **Проверка через API** - можно выполнить тестовый запрос к API для проверки статуса фискализации:

```bash
curl -X GET "https://api.click.uz/v2/merchant/payment/ofd_data/{service_id}/{payment_id}" \
  -H "Accept: application/json" \
  -H "Content-Type: application/json" \
  -H "Auth: {merchant_id}:{sign}:{sign_time}"
```

5. **Проверка QR-кода чека** - полученный QR-код можно отсканировать для проверки валидности фискального чека.

### Тестирование фискализации

Для тестирования фискализации рекомендуется следующий подход:

1. Создайте тестовый заказ через форму покупки тура.
2. Выполните оплату с использованием тестовой карты.
3. После получения уведомления о платеже проверьте логи сервера на наличие сообщений о фискализации.
4. Проверьте уведомление в Telegram на наличие информации о фискальном чеке.
5. Если в уведомлении есть ID фискального чека, фискализация прошла успешно.

### Возможные ошибки при фискализации

1. **"Неверная подпись запроса"** - проверьте правильность формирования подписи для запроса. Подпись должна формироваться по формуле, указанной в документации Click.

2. **"Недостаточно прав для выполнения операции"** - убедитесь, что у вашего аккаунта Click есть права на фискализацию чеков. Обратитесь в службу поддержки Click для проверки прав.

3. **"Неверный формат данных"** - проверьте, что данные для фискализации формируются в правильном формате согласно документации Click.

4. **"Ошибка при отправке данных о товарах и услугах"** - проверьте правильность формирования данных о товарах и услугах, особенно формат цены (в тийинах) и наличие всех обязательных полей.

5. **"Ошибка при получении фискальных данных"** - возможно, фискальный чек еще не создан или произошла ошибка при его создании. Проверьте логи сервера для получения дополнительной информации.

### Использование нескольких ИКПУ

Если вы используете более одного ИКПУ, необходимо указать соответствующий ИКПУ для каждого товара/услуги в массиве `items`. Для этого:

1. Создайте отдельные переменные окружения для каждого ИКПУ, например:
   ```
   CLICK_SPIC_CODE_TOURS=12345678901234567
   CLICK_SPIC_CODE_HOTELS=23456789012345678
   ```

2. В функции фискализации выбирайте нужный ИКПУ в зависимости от типа товара/услуги:
   ```javascript
   const spicCode = type === 'tour' 
     ? process.env.CLICK_SPIC_CODE_TOURS 
     : process.env.CLICK_SPIC_CODE_HOTELS;
   ```

3. Используйте выбранный ИКПУ при формировании данных для фискализации.

## Тестирование

Для тестирования интеграции с Click можно использовать тестовые карты:

- Номер карты: 8600 0000 0000 0000
- Срок действия: любой будущий месяц/год
- Код CVV: любые 3 цифры

## Решение проблем

Если возникают проблемы с интеграцией, проверьте:

1. Правильность настройки переменных окружения
2. Доступность доменов Click (https://my.click.uz и https://api.click.uz)
3. Логи сервера на наличие ошибок
4. Работоспособность Telegram-бота

### Распространенные ошибки

#### "Сессия заблокирована, необходимо повторно авторизоваться"

Эта ошибка может возникать по следующим причинам:

1. **Неверная подпись запроса** - убедитесь, что правильно формируется подпись для запроса. Подпись должна формироваться по формуле: `md5(service_id + merchant_trans_id + sign_time + secret_key)`.

2. **Истек срок действия токена** - в параметре `sign_time` должно передаваться текущее время в миллисекундах. Убедитесь, что на сервере правильно настроено время.

3. **Неверные учетные данные** - проверьте правильность `SERVICE_ID`, `MERCHANT_ID` и `SECRET_KEY` в файле `.env.local`.

4. **Неправильный формат суммы** - сумма должна передаваться без пробелов и других специальных символов. В обновленной версии API мы автоматически удаляем пробелы из суммы.

5. **Проблемы с браузером** - сайт Click требует поддержки WebSocket и JavaScript. Используйте современный браузер (Chrome, Firefox, Safari).

#### "Resource not found" (Ошибка 404) при проверке статуса

Если при обращении к `/api/click/status` вы получаете ошибку "Resource not found" (Ресурс не найден), это может означать:

1. **Изменения в API Click** - API Click может периодически обновляться, и некоторые эндпоинты могут быть изменены или удалены. Наш маршрут `/api/click/status` теперь проверяет только доступность доменов Click и формирование подписи, не пытаясь обращаться к конкретным эндпоинтам API.

2. **Проблемы с доступом к API** - возможно, у вашего аккаунта нет доступа к определенным эндпоинтам API Click. Обратитесь в службу поддержки Click для уточнения доступных вам эндпоинтов.

3. **Сетевые ограничения** - проверьте, нет ли сетевых ограничений, блокирующих доступ к API Click.

Для проверки статуса подключения к Click используйте API-маршрут:
```
GET /api/click/status
```

Этот маршрут проверяет:
- Доступность доменов Click
- Правильность настройки переменных окружения
- Формирование подписи для запроса

#### Ошибки при фискализации чеков

Если возникают проблемы с фискализацией чеков, проверьте:

1. **Правильность кодов ИКПУ и упаковки** - убедитесь, что коды `CLICK_SPIC_CODE` и `CLICK_PACKAGE_CODE` указаны верно в файле `.env.local`.

2. **Доступ к API фискализации** - убедитесь, что у вашего аккаунта Click есть доступ к API фискализации. Для этого обратитесь в службу поддержки Click.

3. **Формат данных** - проверьте, что данные для фискализации формируются в правильном формате согласно документации Click.

4. **Логи сервера** - проверьте логи сервера на наличие ошибок при отправке запроса на фискализацию.

5. **Уведомления в Telegram** - проверьте уведомления в Telegram-боте, в них содержится информация о результате фискализации.

### Отладка

Для отладки интеграции с Click можно использовать следующие инструменты:

1. **Логи сервера** - в консоли сервера выводятся подробные логи о запросах к API Click и ответах от него.

2. **API-маршрут для проверки статуса** - `/api/click/status` позволяет проверить доступность доменов Click и правильность формирования подписи.

3. **Telegram-бот** - в Telegram-бот отправляются уведомления о всех этапах обработки платежа, что позволяет отслеживать процесс оплаты.

4. **Проверка формирования URL** - в ответе маршрута `/api/click/status` содержится тестовый URL для платежа, который можно проверить на правильность формирования.

## Форма сбора данных пользователя

В обновленной версии интеграции добавлена форма для сбора данных пользователя перед оплатой. Это позволяет:

1. **Идентифицировать клиентов** - получать информацию о том, кто совершил покупку
2. **Улучшить коммуникацию** - иметь возможность связаться с клиентом по указанному телефону
3. **Получать информативные уведомления** - в Telegram-бот отправляются уведомления с именем и телефоном клиента

Форма собирает следующие данные:
- Имя пользователя
- Телефон пользователя

Эти данные передаются в API Click и сохраняются в системе для дальнейшего использования.

## Дополнительная информация

Для получения дополнительной информации об API Click обратитесь к официальной документации:
- Общая документация: https://docs.click.uz
- Документация по фискализации: https://docs.click.uz/fiscalization/

### Контакты службы поддержки Click

Если проблемы с интеграцией не удается решить самостоятельно, обратитесь в службу поддержки Click:

- Телефон: +998 71 200 42 20
- Email: support@click.uz
- Сайт: https://click.uz/ru/support 