# Интеграция с платежной системой Click

В этом документе описаны шаги по настройке и использованию интеграции с платежной системой Click в проекте FAXR TRAVEL.

## Настройка переменных окружения

1. Откройте файл `.env.local` в корне проекта и убедитесь, что в нем присутствуют следующие переменные:

```
# Click Payment Integration
CLICK_SECRET_KEY=neLytpXHtYZ
CLICK_SERVICE_ID=68027
CLICK_MERCHANT_ID=36344
CLICK_MERCHANT_USER_ID=52608
CLICK_SPIC_CODE=12345678901234567
CLICK_PACKAGE_CODE=PC001

# Telegram Bot
TELEGRAM_BOT_TOKEN=7553458611:AAFeqiYxdyzvD_lJy4adf8W-dK5lCRnIG9s
TELEGRAM_CHAT_ID=5283151626
```

2. Замените значения переменных на актуальные данные вашего аккаунта Click.

## Настройка Telegram-бота

1. Для получения ID чата, в который будут приходить уведомления о платежах, запустите сервер разработки:

```bash
npm run dev
```

2. Откройте в браузере URL: `http://localhost:5174/api/telegram/setup`

3. Следуйте инструкциям на странице:
   - Добавьте бота в нужный чат или группу
   - Отправьте сообщение в чат с ботом
   - Обновите страницу, чтобы увидеть ID чата
   - Добавьте ID чата в переменную окружения `TELEGRAM_CHAT_ID` в файле `.env.local`

## Процесс оплаты

1. Пользователь нажимает кнопку "Купить" на странице тура
2. Система отображает форму для ввода имени и телефона пользователя
3. После заполнения формы система создает заказ и перенаправляет пользователя на страницу оплаты Click
4. После успешной оплаты пользователь перенаправляется на страницу успешной оплаты
5. Уведомления о платежах с данными пользователя отправляются в настроенный Telegram-чат
6. Система автоматически фискализирует чек через API Click с использованием реальных данных пользователя

## Хранение данных заказа

Для обеспечения корректной работы фискализации и отслеживания заказов, система сохраняет информацию о каждом заказе в файловой системе. Это позволяет:

1. **Использовать реальные данные пользователя** при фискализации чека
2. **Отслеживать статус заказа** на всех этапах обработки
3. **Обеспечивать целостность данных** между созданием заказа и его оплатой

### Структура данных заказа

```javascript
{
  "orderId": "1740757107845",
  "tourId": "123",
  "tourName": "Тур в Самарканд",
  "price": "1000000",
  "userId": "user123",
  "userName": "Иван Иванов",
  "userPhone": "+998 90 123 45 67",
  "status": "Создан",
  "createdAt": "2023-06-28T12:34:56.789Z"
}
```

При подтверждении платежа, статус заказа обновляется на "Оплачен" и добавляется информация о платеже:

```javascript
{
  "status": "Оплачен",
  "paidAt": "2023-06-28T13:00:00.000Z",
  "clickTransId": "12345678"
}
```

### Расположение файлов заказов

Файлы с данными заказов хранятся в директории `data/orders/` в корне проекта. Каждый заказ сохраняется в отдельном файле с именем `{orderId}.json`.

## API-маршруты

- `/api/click` - Инициализация платежа и сохранение данных заказа
- `/api/click/notify` - Обработка уведомлений от Click и фискализация чеков с использованием сохраненных данных заказа
- `/api/telegram/notify` - Отправка уведомлений в Telegram
- `/api/click/status` - Проверка статуса подключения к Click

## Фискализация чеков

В соответствии с требованиями законодательства Узбекистана, система автоматически отправляет фискальные данные в ОФД через API Click. Для этого используются следующие параметры:

- `CLICK_SPIC_CODE` - Код ИКПУ (Идентификационный код предприятия учёта)
- `CLICK_PACKAGE_CODE` - Код упаковки

### Процесс фискализации

1. После успешной оплаты система получает уведомление от Click через API-маршрут `/api/click/notify`
2. Система проверяет подпись запроса и тип действия (action=1 - подтверждение платежа)
3. Система получает сохраненные данные заказа (имя тура, имя и телефон клиента)
4. Если платеж подтвержден, система вызывает функцию `fiscalizeReceipt` для фискализации чека с использованием реальных данных пользователя
5. Функция формирует данные для фискализации и отправляет запрос на API Click
6. Результат фискализации отправляется в Telegram-бот

### Полный процесс фискализации

Фискализация в системе реализована в соответствии с требованиями Click и включает следующие шаги:

1. **Создание фискального чека** - отправка запроса на `https://api.click.uz/v2/merchant/receipt/fiscal` с данными о товаре/услуге, клиенте и платеже.

2. **Отправка данных о товарах и услугах** - после успешного создания чека система отправляет детальные данные о товарах и услугах на `https://api.click.uz/v2/merchant/payment/ofd_data/submit_items`. Данные включают:
   - Название товара/услуги
   - Код ИКПУ
   - Код упаковки
   - Цену в тийинах (1 сум = 100 тийин)
   - Количество
   - Сумму и процент НДС
   - Способ оплаты (наличные, безналичные, электронные)

3. **Получение ссылки на фискальный чек** - система запрашивает ссылку на фискальный чек через `https://api.click.uz/v2/merchant/payment/ofd_data/{service_id}/{payment_id}`.

4. **Отправка QR-кода чека** - полученная ссылка на чек отправляется обратно в Click через `https://api.click.uz/v2/merchant/payment/ofd_data/submit_qrcode`.

### Проверка работы фискализации

Для проверки корректности работы фискализации можно использовать следующие методы:

1. **Проверка логов сервера** - в консоли сервера выводятся подробные логи о запросах к API фискализации и ответах от него. Ищите сообщения, начинающиеся с:
   - "Отправка запроса на фискализацию чека"
   - "Ответ от API фискализации"
   - "Отправка данных о товарах и услугах"
   - "Получение фискальных данных для платежа"
   - "Отправка фискализированного чека"

2. **Проверка уведомлений в Telegram** - после успешной фискализации в Telegram-бот отправляется уведомление с информацией о фискальном чеке, включая его ID.

3. **Проверка через личный кабинет Click** - в личном кабинете Click можно проверить статус фискализации платежей в разделе "Фискальные чеки".

4. **Проверка через API** - можно выполнить тестовый запрос к API для проверки статуса фискализации:

```bash
curl -X GET "https://api.click.uz/v2/merchant/payment/ofd_data/{service_id}/{payment_id}" \
  -H "Accept: application/json" \
  -H "Content-Type: application/json" \
  -H "Auth: {merchant_id}:{sign}:{sign_time}"
```

5. **Проверка QR-кода чека** - полученный QR-код можно отсканировать для проверки валидности фискального чека.

### Тестирование фискализации

Для тестирования фискализации рекомендуется следующий подход:

1. Создайте тестовый заказ через форму покупки тура.
2. Выполните оплату с использованием тестовой карты.
3. После получения уведомления о платеже проверьте логи сервера на наличие сообщений о фискализации.
4. Проверьте уведомление в Telegram на наличие информации о фискальном чеке.
5. Если в уведомлении есть ID фискального чека, фискализация прошла успешно.

### Возможные ошибки при фискализации

1. **"Неверная подпись запроса"** - проверьте правильность формирования подписи для запроса. Подпись должна формироваться по формуле, указанной в документации Click.

2. **"Недостаточно прав для выполнения операции"** - убедитесь, что у вашего аккаунта Click есть права на фискализацию чеков. Обратитесь в службу поддержки Click для проверки прав.

3. **"Неверный формат данных"** - проверьте, что данные для фискализации формируются в правильном формате согласно документации Click.

4. **"Ошибка при отправке данных о товарах и услугах"** - проверьте правильность формирования данных о товарах и услугах, особенно формат цены (в тийинах) и наличие всех обязательных полей.

5. **"Ошибка при получении фискальных данных"** - возможно, фискальный чек еще не создан или произошла ошибка при его создании. Проверьте логи сервера для получения дополнительной информации.

### Использование нескольких ИКПУ

Если вы используете более одного ИКПУ, необходимо указать соответствующий ИКПУ для каждого товара/услуги в массиве `items`. Для этого:

1. Создайте отдельные переменные окружения для каждого ИКПУ, например:
   ```
   CLICK_SPIC_CODE_TOURS=12345678901234567
   CLICK_SPIC_CODE_HOTELS=23456789012345678
   ```

2. В функции фискализации выбирайте нужный ИКПУ в зависимости от типа товара/услуги:
   ```javascript
   const spicCode = type === 'tour' 
     ? process.env.CLICK_SPIC_CODE_TOURS 
     : process.env.CLICK_SPIC_CODE_HOTELS;
   ```

3. Используйте выбранный ИКПУ при формировании данных для фискализации.

## Тестирование

Для тестирования интеграции с Click можно использовать тестовые карты:

- Номер карты: 8600 0000 0000 0000
- Срок действия: любой будущий месяц/год
- Код CVV: любые 3 цифры

## Решение проблем

Если возникают проблемы с интеграцией, проверьте:

1. Правильность настройки переменных окружения
2. Доступность доменов Click (https://my.click.uz и https://api.click.uz)
3. Логи сервера на наличие ошибок
4. Работоспособность Telegram-бота

### Распространенные ошибки

#### "Сессия заблокирована, необходимо повторно авторизоваться"

Эта ошибка может возникать по следующим причинам:

1. **Неверная подпись запроса** - убедитесь, что правильно формируется подпись для запроса. Подпись должна формироваться по формуле: `md5(service_id + merchant_trans_id + sign_time + secret_key)`.

2. **Истек срок действия токена** - в параметре `sign_time` должно передаваться текущее время в миллисекундах. Убедитесь, что на сервере правильно настроено время.

3. **Неверные учетные данные** - проверьте правильность `SERVICE_ID`, `MERCHANT_ID` и `SECRET_KEY` в файле `.env.local`.

4. **Неправильный формат суммы** - сумма должна передаваться без пробелов и других специальных символов. В обновленной версии API мы автоматически удаляем пробелы из суммы.

5. **Проблемы с браузером** - сайт Click требует поддержки WebSocket и JavaScript. Используйте современный браузер (Chrome, Firefox, Safari).

#### "Resource not found" (Ошибка 404) при проверке статуса

Если при обращении к `/api/click/status` вы получаете ошибку "Resource not found" (Ресурс не найден), это может означать:

1. **Изменения в API Click** - API Click может периодически обновляться, и некоторые эндпоинты могут быть изменены или удалены. Наш маршрут `/api/click/status` теперь проверяет только доступность доменов Click и формирование подписи, не пытаясь обращаться к конкретным эндпоинтам API.

2. **Проблемы с доступом к API** - возможно, у вашего аккаунта нет доступа к определенным эндпоинтам API Click. Обратитесь в службу поддержки Click для уточнения доступных вам эндпоинтов.

3. **Сетевые ограничения** - проверьте, нет ли сетевых ограничений, блокирующих доступ к API Click.

Для проверки статуса подключения к Click используйте API-маршрут:
```
GET /api/click/status
```

Этот маршрут проверяет:
- Доступность доменов Click
- Правильность настройки переменных окружения
- Формирование подписи для запроса

#### Ошибки при фискализации чеков

Если возникают проблемы с фискализацией чеков, проверьте:

1. **Правильность кодов ИКПУ и упаковки** - убедитесь, что коды `CLICK_SPIC_CODE` и `CLICK_PACKAGE_CODE` указаны верно в файле `.env.local`.

2. **Доступ к API фискализации** - убедитесь, что у вашего аккаунта Click есть доступ к API фискализации. Для этого обратитесь в службу поддержки Click.

3. **Формат данных** - проверьте, что данные для фискализации формируются в правильном формате согласно документации Click.

4. **Логи сервера** - проверьте логи сервера на наличие ошибок при отправке запроса на фискализацию.

5. **Уведомления в Telegram** - проверьте уведомления в Telegram-боте, в них содержится информация о результате фискализации.

### Отладка

Для отладки интеграции с Click можно использовать следующие инструменты:

1. **Логи сервера** - в консоли сервера выводятся подробные логи о запросах к API Click и ответах от него.

2. **API-маршрут для проверки статуса** - `/api/click/status` позволяет проверить доступность доменов Click и правильность формирования подписи.

3. **Telegram-бот** - в Telegram-бот отправляются уведомления о всех этапах обработки платежа, что позволяет отслеживать процесс оплаты.

4. **Проверка формирования URL** - в ответе маршрута `/api/click/status` содержится тестовый URL для платежа, который можно проверить на правильность формирования.

## Форма сбора данных пользователя

В обновленной версии интеграции добавлена форма для сбора данных пользователя перед оплатой. Это позволяет:

1. **Идентифицировать клиентов** - получать информацию о том, кто совершил покупку
2. **Улучшить коммуникацию** - иметь возможность связаться с клиентом по указанному телефону
3. **Получать информативные уведомления** - в Telegram-бот отправляются уведомления с именем и телефоном клиента

Форма собирает следующие данные:
- Имя пользователя
- Телефон пользователя

Эти данные передаются в API Click и сохраняются в системе для дальнейшего использования.

## Дополнительная информация

Для получения дополнительной информации об API Click обратитесь к официальной документации:
- Общая документация: https://docs.click.uz
- Документация по фискализации: https://docs.click.uz/fiscalization/

### Контакты службы поддержки Click

Если проблемы с интеграцией не удается решить самостоятельно, обратитесь в службу поддержки Click:

- Телефон: +998 71 200 42 20
- Email: support@click.uz
- Сайт: https://click.uz/ru/support

## Тестирование интеграции с Click API

В соответствии с официальной документацией Click, перед использованием интеграции в рабочем режиме необходимо провести тестирование:

1. **Ознакомьтесь с документацией Click API**:
   - Общая документация: [docs.click.uz](https://docs.click.uz)
   - Документация по фискализации: [docs.click.uz/fiscalization](https://docs.click.uz/fiscalization)
   - Инструкция по интеграции: [docs.click.uz/click-api-request](https://docs.click.uz/click-api-request)

2. **Проведите тестирование интеграции**:
   - Используйте ПО для тестирования: [docs.click.uz/click-api-testing](https://docs.click.uz/click-api-testing)
   - Проверьте корректность обработки уведомлений от Click
   - Проверьте корректность фискализации чеков

3. **Настройте сервис в личном кабинете Click**:
   - Авторизуйтесь в кабинете [merchant.click.uz](https://merchant.click.uz)
   - Перейдите в категорию "Сервисы" (слева в кабинете)
   - Нажмите на иконку карандаша в поле "Действие" (в крайней правой ячейке таблицы)
   - Пропишите реализованные адреса проверки и результата (backend/callback URL):
     - URL проверки: `https://ваш-домен.uz/api/click/notify`
     - URL результата: `https://ваш-домен.uz/payment/success`

4. **Уведомите Click о готовности к активации**:
   - После настройки URL-адресов уведомите службу поддержки Click для активации сервиса
   - По умолчанию сервис отключен и требует активации со стороны Click

## Настройка IP-адресов и доменов

Важно учитывать следующие требования к IP-адресам и доменам:

1. **Для серверов вне сети TAS-IX**:
   - Необходимо заранее предупредить Click ДО ПОПЫТКИ первого реального платежа
   - Предоставить Click следующую информацию:
     - Домен (при наличии)
     - IP-адрес сервера
     - Порт для добавления в белый список файрвола

2. **Требования к IP-адресу**:
   - IP-адрес должен быть статическим
   - Перед изменением IP-адреса или домена необходимо уведомить Click
   - Замену IP-адреса или домена производить только после настройки со стороны Click

3. **Проверка доступности**:
   - Убедитесь, что ваш сервер доступен из интернета
   - Проверьте настройки файрвола на вашей стороне
   - Убедитесь, что порты для HTTP/HTTPS (80/443) открыты для входящих соединений от Click

## Активация сервиса

После успешного тестирования и настройки необходимо активировать сервис:

1. **Отправьте запрос на активацию**:
   - Напишите в службу поддержки Click с просьбой активировать ваш сервис
   - Укажите ID сервиса и мерчанта
   - Подтвердите, что тестирование прошло успешно

2. **Дождитесь подтверждения**:
   - Click проверит корректность настройки вашего сервиса
   - После проверки Click активирует ваш сервис
   - Вы получите уведомление об активации

3. **Проведите тестовый платеж**:
   - После активации сервиса проведите тестовый платеж
   - Убедитесь, что платеж проходит успешно
   - Проверьте корректность фискализации чека 

## Проверка готовности интеграции к продакшену

Перед переходом в продакшен необходимо убедиться, что все компоненты интеграции работают корректно. Для этого выполните следующие проверки:

### 1. Проверка статуса подключения

Выполните запрос к API-маршруту `/api/click/status`:

```bash
curl -X GET http://localhost:5174/api/click/status
```

Ответ должен содержать следующую информацию:
- Статус подключения к Click (`status: "success"`)
- Доступность доменов Click (`clickDomain: true`, `apiDomain: true`)
- Настройки конфигурации (`serviceId`, `merchantId`, `merchantUserId`)
- Статус настройки фискализации (`fiscalizationConfigured: true`)
- Тестовую подпись и URL для платежа
- Статус доступности API фискализации

Пример успешного ответа:
```json
{
  "status": "success",
  "message": "Проверка подключения к Click выполнена",
  "availability": {
    "clickDomain": true,
    "apiDomain": true
  },
  "config": {
    "serviceId": "68027",
    "merchantId": "36344",
    "merchantUserId": "52608",
    "fiscalizationConfigured": true
  },
  "fiscalizationStatus": {
    "fiscalApiAvailable": true,
    "submitItemsAvailable": true,
    "submitQrCodeAvailable": true,
    "spicCode": "12345678901234567",
    "packageCode": "PC001"
  }
}
```

### 2. Проверка создания платежа

Выполните тестовый запрос на создание платежа:

```bash
curl -X POST http://localhost:5174/api/click \
  -H "Content-Type: application/json" \
  -d '{"tourId":"test-123","tourName":"Тестовый тур","price":"10000","userName":"Тест Тестов","userPhone":"+998901234567"}'
```

Ответ должен содержать URL для перенаправления на страницу оплаты Click:
```json
{
  "success": true,
  "redirectUrl": "https://my.click.uz/services/pay?service_id=68027&merchant_id=36344&amount=10000&transaction_param=1740759503049&return_url=https%3A%2F%2Fexample.com%2Fpayment%2Fsuccess&card_type=uzcard&sign_time=1740759503049&sign_string=95290cd9ab4fcd8e26f8afd16a73732d",
  "orderId": "1740759503049"
}
```

### 3. Проверка обработки уведомлений

Для проверки обработки уведомлений от Click можно использовать инструмент для тестирования API Click: [docs.click.uz/click-api-testing](https://docs.click.uz/click-api-testing).

Также можно выполнить тестовый запрос к API-маршруту `/api/click/notify`:

```bash
curl -X POST http://localhost:5174/api/click/notify \
  -H "Content-Type: application/json" \
  -d '{
    "click_trans_id": "test-12345",
    "service_id": "68027",
    "merchant_trans_id": "1740759503049",
    "amount": "10000",
    "action": "1",
    "sign_time": "1740759503049",
    "sign_string": "95290cd9ab4fcd8e26f8afd16a73732d",
    "error": "0"
  }'
```

### 4. Проверка фискализации

Для проверки фискализации необходимо выполнить полный цикл платежа:

1. Создать платеж через форму на сайте
2. Выполнить оплату с использованием тестовой карты
3. Дождаться уведомления от Click
4. Проверить логи сервера на наличие сообщений о фискализации
5. Проверить уведомление в Telegram на наличие информации о фискальном чеке

### 5. Проверка в продакшен-окружении

Перед запуском в продакшен рекомендуется выполнить все проверки в продакшен-окружении:

1. Разверните приложение на продакшен-сервере
2. Настройте переменные окружения с реальными данными
3. Выполните все вышеперечисленные проверки
4. Убедитесь, что все компоненты интеграции работают корректно

### 6. Чек-лист готовности к продакшену

- [ ] Настроены все необходимые переменные окружения
- [ ] API-маршрут `/api/click/status` возвращает успешный статус
- [ ] API-маршрут `/api/click` корректно создает платежи
- [ ] API-маршрут `/api/click/notify` корректно обрабатывает уведомления
- [ ] Фискализация чеков работает корректно
- [ ] Уведомления в Telegram отправляются корректно
- [ ] Сервис активирован в личном кабинете Click
- [ ] IP-адрес сервера добавлен в белый список Click (для серверов вне TAS-IX)
- [ ] Проведено тестирование в продакшен-окружении

После выполнения всех пунктов чек-листа интеграция готова к использованию в продакшен-режиме.

## Формирование подписи для уведомлений

При обработке уведомлений от Click важно правильно формировать и проверять подпись запроса. Подпись формируется по-разному для разных типов запросов:

### 1. Подпись для создания платежа

Для создания платежа (маршрут `/api/click`) подпись формируется по формуле:
```
sign_string = md5(service_id + merchant_trans_id + sign_time + secret_key)
```

Пример:
```javascript
const signString = `${serviceId}${orderId}${signTime}${secretKey}`;
const sign = crypto.createHash('md5').update(signString).digest('hex');
```

### 2. Подпись для уведомлений от Click

Для проверки подписи в уведомлениях от Click (маршрут `/api/click/notify`) используется другая формула:
```
sign_string = md5(click_trans_id + service_id + merchant_trans_id + amount + action + sign_time + secret_key)
```

Пример:
```javascript
const signString = `${click_trans_id}${service_id}${merchant_trans_id}${amount}${action}${sign_time}${secretKey}`;
const sign = crypto.createHash('md5').update(signString).digest('hex');
```

### 3. Подпись для запросов к API фискализации

Для запросов к API фискализации (функции `fiscalizeReceipt`, `submitFiscalItems`, `getFiscalData`, `submitFiscalQRCode`) подпись формируется по формуле:
```
sign_string = md5(merchant_id + sign_time + secret_key)
```

Пример:
```javascript
const signString = `${merchantId}${signTime}${secretKey}`;
const sign = crypto.createHash('md5').update(signString).digest('hex');
```

### Пример тестирования уведомления с правильной подписью

Для тестирования обработки уведомлений с правильной подписью можно использовать следующий скрипт:

```javascript
const crypto = require('crypto');

// Данные для формирования подписи
const click_trans_id = "test-12345";
const service_id = "68027";
const merchant_trans_id = "1740759561522";
const amount = "10000";
const action = "1";
const sign_time = "1740759561522";
const secret_key = "neLytpXHtYZ"; // Ваш секретный ключ

// Формируем подпись
const signString = `${click_trans_id}${service_id}${merchant_trans_id}${amount}${action}${sign_time}${secret_key}`;
const sign = crypto.createHash('md5').update(signString).digest('hex');

console.log("Сформированная подпись:", sign);
console.log("Данные для запроса:", {
  click_trans_id,
  service_id,
  merchant_trans_id,
  amount,
  action,
  sign_time,
  sign_string: sign,
  error: "0"
});
```

Затем можно использовать полученную подпись для тестирования:

```bash
curl -X POST http://localhost:5174/api/click/notify \
  -H "Content-Type: application/json" \
  -d '{
    "click_trans_id": "test-12345",
    "service_id": "68027",
    "merchant_trans_id": "1740759561522",
    "amount": "10000",
    "action": "1",
    "sign_time": "1740759561522",
    "sign_string": "ПОЛУЧЕННАЯ_ПОДПИСЬ",
    "error": "0"
  }'
```

### Важные моменты при формировании подписи

1. **Порядок параметров** - важно соблюдать правильный порядок параметров при формировании подписи.
2. **Формат данных** - все параметры должны быть в строковом формате.
3. **Секретный ключ** - используйте секретный ключ, указанный в переменной окружения `CLICK_SECRET_KEY`.
4. **Алгоритм хеширования** - используйте алгоритм MD5 для формирования подписи.
5. **Время подписи** - параметр `sign_time` должен быть текущим временем в миллисекундах.

## Тестирование

Для тестирования интеграции с Click можно использовать тестовые карты:

- Номер карты: 8600 0000 0000 0000
- Срок действия: любой будущий месяц/год
- Код CVV: любые 3 цифры

## Решение проблем

Если возникают проблемы с интеграцией, проверьте:

1. Правильность настройки переменных окружения
2. Доступность доменов Click (https://my.click.uz и https://api.click.uz)
3. Логи сервера на наличие ошибок
4. Работоспособность Telegram-бота

### Распространенные ошибки

#### "Сессия заблокирована, необходимо повторно авторизоваться"

Эта ошибка может возникать по следующим причинам:

1. **Неверная подпись запроса** - убедитесь, что правильно формируется подпись для запроса. Подпись должна формироваться по формуле: `md5(service_id + merchant_trans_id + sign_time + secret_key)`.

2. **Истек срок действия токена** - в параметре `sign_time` должно передаваться текущее время в миллисекундах. Убедитесь, что на сервере правильно настроено время.

3. **Неверные учетные данные** - проверьте правильность `SERVICE_ID`, `MERCHANT_ID` и `SECRET_KEY` в файле `.env.local`.

4. **Неправильный формат суммы** - сумма должна передаваться без пробелов и других специальных символов. В обновленной версии API мы автоматически удаляем пробелы из суммы.

5. **Проблемы с браузером** - сайт Click требует поддержки WebSocket и JavaScript. Используйте современный браузер (Chrome, Firefox, Safari).

#### "Resource not found" (Ошибка 404) при проверке статуса

Если при обращении к `/api/click/status` вы получаете ошибку "Resource not found" (Ресурс не найден), это может означать:

1. **Изменения в API Click** - API Click может периодически обновляться, и некоторые эндпоинты могут быть изменены или удалены. Наш маршрут `/api/click/status` теперь проверяет только доступность доменов Click и формирование подписи, не пытаясь обращаться к конкретным эндпоинтам API.

2. **Проблемы с доступом к API** - возможно, у вашего аккаунта нет доступа к определенным эндпоинтам API Click. Обратитесь в службу поддержки Click для уточнения доступных вам эндпоинтов.

3. **Сетевые ограничения** - проверьте, нет ли сетевых ограничений, блокирующих доступ к API Click.

Для проверки статуса подключения к Click используйте API-маршрут:
```
GET /api/click/status
```

Этот маршрут проверяет:
- Доступность доменов Click
- Правильность настройки переменных окружения
- Формирование подписи для запроса

#### Ошибки при фискализации чеков

Если возникают проблемы с фискализацией чеков, проверьте:

1. **Правильность кодов ИКПУ и упаковки** - убедитесь, что коды `CLICK_SPIC_CODE` и `CLICK_PACKAGE_CODE` указаны верно в файле `.env.local`.

2. **Доступ к API фискализации** - убедитесь, что у вашего аккаунта Click есть доступ к API фискализации. Для этого обратитесь в службу поддержки Click.

3. **Формат данных** - проверьте, что данные для фискализации формируются в правильном формате согласно документации Click.

4. **Логи сервера** - проверьте логи сервера на наличие ошибок при отправке запроса на фискализацию.

5. **Уведомления в Telegram** - проверьте уведомления в Telegram-боте, в них содержится информация о результате фискализации.

### Отладка

Для отладки интеграции с Click можно использовать следующие инструменты:

1. **Логи сервера** - в консоли сервера выводятся подробные логи о запросах к API Click и ответах от него.

2. **API-маршрут для проверки статуса** - `/api/click/status` позволяет проверить доступность доменов Click и правильность формирования подписи.

3. **Telegram-бот** - в Telegram-бот отправляются уведомления о всех этапах обработки платежа, что позволяет отслеживать процесс оплаты.

4. **Проверка формирования URL** - в ответе маршрута `/api/click/status` содержится тестовый URL для платежа, который можно проверить на правильность формирования.

## Форма сбора данных пользователя

В обновленной версии интеграции добавлена форма для сбора данных пользователя перед оплатой. Это позволяет:

1. **Идентифицировать клиентов** - получать информацию о том, кто совершил покупку
2. **Улучшить коммуникацию** - иметь возможность связаться с клиентом по указанному телефону
3. **Получать информативные уведомления** - в Telegram-бот отправляются уведомления с именем и телефоном клиента

Форма собирает следующие данные:
- Имя пользователя
- Телефон пользователя

Эти данные передаются в API Click и сохраняются в системе для дальнейшего использования.

## Дополнительная информация

Для получения дополнительной информации об API Click обратитесь к официальной документации:
- Общая документация: https://docs.click.uz
- Документация по фискализации: https://docs.click.uz/fiscalization/

### Контакты службы поддержки Click

Если проблемы с интеграцией не удается решить самостоятельно, обратитесь в службу поддержки Click:

- Телефон: +998 71 200 42 20
- Email: support@click.uz
- Сайт: https://click.uz/ru/support

## Тестирование интеграции с Click API

В соответствии с официальной документацией Click, перед использованием интеграции в рабочем режиме необходимо провести тестирование:

1. **Ознакомьтесь с документацией Click API**:
   - Общая документация: [docs.click.uz](https://docs.click.uz)
   - Документация по фискализации: [docs.click.uz/fiscalization](https://docs.click.uz/fiscalization)
   - Инструкция по интеграции: [docs.click.uz/click-api-request](https://docs.click.uz/click-api-request)

2. **Проведите тестирование интеграции**:
   - Используйте ПО для тестирования: [docs.click.uz/click-api-testing](https://docs.click.uz/click-api-testing)
   - Проверьте корректность обработки уведомлений от Click
   - Проверьте корректность фискализации чеков

3. **Настройте сервис в личном кабинете Click**:
   - Авторизуйтесь в кабинете [merchant.click.uz](https://merchant.click.uz)
   - Перейдите в категорию "Сервисы" (слева в кабинете)
   - Нажмите на иконку карандаша в поле "Действие" (в крайней правой ячейке таблицы)
   - Пропишите реализованные адреса проверки и результата (backend/callback URL):
     - URL проверки: `https://ваш-домен.uz/api/click/notify`
     - URL результата: `https://ваш-домен.uz/payment/success`

4. **Уведомите Click о готовности к активации**:
   - После настройки URL-адресов уведомите службу поддержки Click для активации сервиса
   - По умолчанию сервис отключен и требует активации со стороны Click

## Настройка IP-адресов и доменов

Важно учитывать следующие требования к IP-адресам и доменам:

1. **Для серверов вне сети TAS-IX**:
   - Необходимо заранее предупредить Click ДО ПОПЫТКИ первого реального платежа
   - Предоставить Click следующую информацию:
     - Домен (при наличии)
     - IP-адрес сервера
     - Порт для добавления в белый список файрвола

2. **Требования к IP-адресу**:
   - IP-адрес должен быть статическим
   - Перед изменением IP-адреса или домена необходимо уведомить Click
   - Замену IP-адреса или домена производить только после настройки со стороны Click

3. **Проверка доступности**:
   - Убедитесь, что ваш сервер доступен из интернета
   - Проверьте настройки файрвола на вашей стороне
   - Убедитесь, что порты для HTTP/HTTPS (80/443) открыты для входящих соединений от Click

## Активация сервиса

После успешного тестирования и настройки необходимо активировать сервис:

1. **Отправьте запрос на активацию**:
   - Напишите в службу поддержки Click с просьбой активировать ваш сервис
   - Укажите ID сервиса и мерчанта
   - Подтвердите, что тестирование прошло успешно

2. **Дождитесь подтверждения**:
   - Click проверит корректность настройки вашего сервиса
   - После проверки Click активирует ваш сервис
   - Вы получите уведомление об активации

3. **Проведите тестовый платеж**:
   - После активации сервиса проведите тестовый платеж
   - Убедитесь, что платеж проходит успешно
   - Проверьте корректность фискализации чека 

## Проверка готовности интеграции к продакшену

Перед переходом в продакшен необходимо убедиться, что все компоненты интеграции работают корректно. Для этого выполните следующие проверки:

### 1. Проверка статуса подключения

Выполните запрос к API-маршруту `/api/click/status`:

```bash
curl -X GET http://localhost:5174/api/click/status
```

Ответ должен содержать следующую информацию:
- Статус подключения к Click (`status: "success"`)
- Доступность доменов Click (`clickDomain: true`, `apiDomain: true`)
- Настройки конфигурации (`serviceId`, `merchantId`, `merchantUserId`)
- Статус настройки фискализации (`fiscalizationConfigured: true`)
- Тестовую подпись и URL для платежа
- Статус доступности API фискализации

Пример успешного ответа:
```json
{
  "status": "success",
  "message": "Проверка подключения к Click выполнена",
  "availability": {
    "clickDomain": true,
    "apiDomain": true
  },
  "config": {
    "serviceId": "68027",
    "merchantId": "36344",
    "merchantUserId": "52608",
    "fiscalizationConfigured": true
  },
  "fiscalizationStatus": {
    "fiscalApiAvailable": true,
    "submitItemsAvailable": true,
    "submitQrCodeAvailable": true,
    "spicCode": "12345678901234567",
    "packageCode": "PC001"
  }
}
```

### 2. Проверка создания платежа

Выполните тестовый запрос на создание платежа:

```bash
curl -X POST http://localhost:5174/api/click \
  -H "Content-Type: application/json" \
  -d '{"tourId":"test-123","tourName":"Тестовый тур","price":"10000","userName":"Тест Тестов","userPhone":"+998901234567"}'
```

Ответ должен содержать URL для перенаправления на страницу оплаты Click:
```json
{
  "success": true,
  "redirectUrl": "https://my.click.uz/services/pay?service_id=68027&merchant_id=36344&amount=10000&transaction_param=1740759503049&return_url=https%3A%2F%2Fexample.com%2Fpayment%2Fsuccess&card_type=uzcard&sign_time=1740759503049&sign_string=95290cd9ab4fcd8e26f8afd16a73732d",
  "orderId": "1740759503049"
}
```

### 3. Проверка обработки уведомлений

Для проверки обработки уведомлений от Click можно использовать инструмент для тестирования API Click: [docs.click.uz/click-api-testing](https://docs.click.uz/click-api-testing).

Также можно выполнить тестовый запрос к API-маршруту `/api/click/notify`:

```bash
curl -X POST http://localhost:5174/api/click/notify \
  -H "Content-Type: application/json" \
  -d '{
    "click_trans_id": "test-12345",
    "service_id": "68027",
    "merchant_trans_id": "1740759503049",
    "amount": "10000",
    "action": "1",
    "sign_time": "1740759503049",
    "sign_string": "95290cd9ab4fcd8e26f8afd16a73732d",
    "error": "0"
  }'
```

### 4. Проверка фискализации

Для проверки фискализации необходимо выполнить полный цикл платежа:

1. Создать платеж через форму на сайте
2. Выполнить оплату с использованием тестовой карты
3. Дождаться уведомления от Click
4. Проверить логи сервера на наличие сообщений о фискализации
5. Проверить уведомление в Telegram на наличие информации о фискальном чеке

### 5. Проверка в продакшен-окружении

Перед запуском в продакшен рекомендуется выполнить все проверки в продакшен-окружении:

1. Разверните приложение на продакшен-сервере
2. Настройте переменные окружения с реальными данными
3. Выполните все вышеперечисленные проверки
4. Убедитесь, что все компоненты интеграции работают корректно

### 6. Чек-лист готовности к продакшену

- [ ] Настроены все необходимые переменные окружения
- [ ] API-маршрут `/api/click/status` возвращает успешный статус
- [ ] API-маршрут `/api/click` корректно создает платежи
- [ ] API-маршрут `/api/click/notify` корректно обрабатывает уведомления
- [ ] Фискализация чеков работает корректно
- [ ] Уведомления в Telegram отправляются корректно
- [ ] Сервис активирован в личном кабинете Click
- [ ] IP-адрес сервера добавлен в белый список Click (для серверов вне TAS-IX)
- [ ] Проведено тестирование в продакшен-окружении

После выполнения всех пунктов чек-листа интеграция готова к использованию в продакшен-режиме. 